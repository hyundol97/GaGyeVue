name: Deploy Vite to S3 + CloudFront

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            # 1. 코드 가져오기
            - name: Checkout
              uses: actions/checkout@v4

            # 2. Node 설치
            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 24
                  cache: 'npm'

            # 3. 의존성 설치
            - name: Install dependencies
              run: npm ci

            # 4. 빌드
            - name: Build
              run: npm run build

            # 5. AWS 인증
            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ secrets.AWS_REGION }}

            # 6. S3 배포 (기존 파일 삭제)
            - name: Sync to S3
              run: |
                  aws s3 sync dist s3://${{ secrets.S3_BUCKET }} --delete

            # 7. CloudFront 캐시 무효화
            - name: Invalidate CloudFront
              run: |
                  aws cloudfront create-invalidation \
                    --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
                    --paths "/*"
